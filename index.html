<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MatchaTone — state videos</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.3/lib/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.3/lib/addons/p5.sound.min.js"></script>
</head>
<body>
  <div id="app">
    <div id="loading">Loading…</div>

    <!-- 中心区域：只显示角色和两个按钮 -->
    <div id="stageWrapper">
      <div id="stage"></div>
      <button id="startBtn">Start</button>

      <div id="floatingButtons">
        <button id="helpBtn" class="icon-btn">
          <img src="assets/icon_help.png" alt="Help">
        </button>
        <button id="aboutBtn" class="icon-btn">
          <img src="assets/icon_about.png" alt="About">
        </button>
        <button id="settingsBtn" class="icon-btn">
          <img src="assets/icon_settings.png" alt="Settings">
        </button>
      </div>
    </div>

    <!-- 可以保留一个小 HUD，如果你想也可以在 CSS 里隐藏 -->
    <div id="hud">
      <span id="stateTxt">state: live</span>
      <span id="micTxt">mic: idle</span>
      <span id="lvlTxt">level: 0.000</span>
      <span id="dbTxt">~ dB: -∞</span>
    </div>

    <div id="promptBar" aria-live="polite"></div>

    <!-- ========== 设置弹窗（里面是原来的调试面板） ========== -->
    <div id="settingsOverlay" class="overlay">
      <div class="overlay-backdrop" id="settingsBackdrop"></div>
      <div class="overlay-card">
        <button class="close-btn" id="settingsClose">×</button>
        <h2 class="overlay-title">Settings</h2>

        <div id="panel">
          <button id="calBtn">Calibrate 2s</button>
          <button id="muteBtn">Mute Mic</button>

          <label> Mic
            <select id="micSelect"></select>
          </label>
          <button id="refreshBtn">Refresh</button>

          <label> Sensitivity
            <input id="sens" type="range" min="0.05" max="4" value="1" step="0.05">
          </label>
          <label> Soft TH
            <input id="softTH" type="range" min="0.001" max="0.1" value="0.02" step="0.001">
          </label>
          <label> Loud TH
            <input id="loudTH" type="range" min="0.05" max="0.5" value="0.12" step="0.01">
          </label>

          <div id="meterWrap">
            <div id="meterBar"></div>
          </div>
          <div id="tips">
            Tip: If level stays at 0, check browser mic permission or click Start again.
          </div>
        </div>
      </div>
    </div>

    <!-- ========== 指南弹窗（交互说明） ========== -->
    <div id="helpOverlay" class="overlay">
      <div class="overlay-backdrop" id="helpBackdrop"></div>
      <div class="overlay-card">
        <button class="close-btn" id="helpClose">×</button>
        <h2 class="overlay-title">How to Test</h2>
        <div id="helpContent">

          <p><b>MatchaTone is a small desk companion that reacts gently to your sound and touch.</b></p>

          <h4>Sound triggers</h4>
          <ul>
            <li>
              <b>Soft sound → Listening</b><br>
              When the character is in the live state, a soft and steady sound above the soft
              threshold triggers listening.  
              This happens after the sound stays in the soft range for about <b>0.5 seconds</b>.
            </li>

            <li>
              <b>Loud sound → Shy</b><br>
              A volume above the loud threshold instantly makes the character shy.  
              Loud sound can also wake the character from sleep.
            </li>

            <li>
              <b>Silence → Sleep</b><br>
              If the character stays in the live state with no meaningful sound for about  
              <b>80 seconds</b>, it slowly falls asleep.
            </li>

            <li>
              <b>Threshold ranges</b><br>
              Soft sound is between the soft and loud thresholds  
              (default soft ≈ 0.02, loud ≈ 0.12).  
              Anything below the soft threshold counts as quiet.
            </li>
          </ul>

          <h4>Touch trigger</h4>
          <ul>
            <li>
              <b>Tap → Happy</b><br>
              Tapping the stage makes the character happy with a short joyful sequence and its
              own looping music.  
              This cannot happen during sleep.
            </li>
          </ul>

          <h4>State timing</h4>
          <ul>
            <li><b>Happy</b> plays for about <b>10 seconds</b> before another interaction can happen.</li>
            <li><b>Shy</b> lasts for about <b>2 seconds</b>.</li>
            <li><b>Listening In / Out</b> each take about <b>1.2 seconds</b>.</li>
            <li><b>Listening Loop</b> lasts at least <b>10 seconds</b> before exiting.</li>
            <li><b>Listening Cooldown</b>: after finishing listening, the character will not listen again for about <b>60 seconds</b>.</li>
            <li><b>Sleep Loop</b> stays for at least <b>60 seconds</b> unless a loud sound wakes it.</li>
          </ul>

          <h4>State overview</h4>
          <ul>
            <li><b>Live</b> calm idle state, used as the base for all interactions.</li>
            <li><b>Listening</b> triggered by steady soft sound when calm enough. The character moves closer and listens.</li>
            <li><b>Happy</b> triggered by tapping the stage, plays a joyful animation with BGM.</li>
            <li><b>Shy</b> triggered by loud sound, a fast startled reaction.</li>
            <li><b>Sleep</b> triggered only after long quiet time in live, with its own sleep BGM.</li>
          </ul>

          <h4>Prompt bar</h4>
          <p>
            In the live state, the character sometimes shows a small message inviting you to talk.  
            Prompts appear only after the character has been calm for a while and never appear during sleep.
          </p>

          <h4>Tips</h4>
          <ul>
            <li>You can adjust sensitivity and thresholds in the Settings panel.</li>
            <li>You may mute or unmute the microphone with the button or the M key.</li>
            <li>Headphones and a quiet room give the most stable reactions.</li>
          </ul>

        </div>


      </div>
    </div>

  </div>
  <script src="sketch.js"></script>
</body>
</html>

    <!-- ========== 关于角色弹窗（aboutOverlay） ========== -->
    <div id="aboutOverlay" class="overlay">
      <div class="overlay-backdrop" id="aboutBackdrop"></div>
      <div class="overlay-card">
        <button class="close-btn" id="aboutClose">×</button>
        <h2 class="overlay-title">About MatchaTone</h2>
        <div id="aboutContent">
          <p>
            MatchaTone is a gentle companion that listens, reacts, and rests.
            It breathes with sound, blushes when surprised, and smiles when touched.
            A small window into emotion through simple interaction.
          </p>
        </div>
      </div>
    </div>
